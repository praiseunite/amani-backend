name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Run Black (Code Formatter Check)
      run: |
        black --check --diff app/ tests/
        
    - name: Run Flake8 (Linting)
      run: |
        flake8 app/ tests/

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Run unit tests with coverage
      env:
        SECRET_KEY: test-secret-key-for-ci
        DATABASE_URL: postgresql+asyncpg://test:test@localhost/test
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        pytest tests/unit/ -v -m "unit or not integration" \
          --cov=app.domain \
          --cov=app.ports \
          --cov=app.application \
          --cov-report=term-missing \
          --cov-report=xml:coverage-unit.xml \
          --cov-fail-under=85
        
    - name: Upload unit test coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage-unit.xml
        flags: unit-tests
        name: unit-tests-coverage
        fail_ci_if_error: false
      if: always()

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Run Alembic migrations
      env:
        DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        alembic upgrade head
        
    - name: Run integration tests with coverage
      env:
        TEST_DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        pytest tests/integration/ -v -m "integration" \
          --cov=app \
          --cov-report=term-missing \
          --cov-report=xml:coverage-integration.xml \
          --tb=short
        
    - name: Upload integration test coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage-integration.xml
        flags: integration-tests
        name: integration-tests-coverage
        fail_ci_if_error: false
      if: always()

  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Run API tests with coverage
      env:
        SECRET_KEY: test-secret-key-for-ci
        DATABASE_URL: postgresql+asyncpg://test:test@localhost/test
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        pytest tests/api/ -v \
          --cov=app.api \
          --cov=app.application \
          --cov-report=term-missing \
          --cov-report=xml:coverage-api.xml
        
    - name: Upload API test coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage-api.xml
        flags: api-tests
        name: api-tests-coverage
        fail_ci_if_error: false
      if: always()

  migration-tests:
    name: Migration Up/Down Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Test migrations up
      env:
        DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        echo "Running migrations upgrade to head..."
        alembic upgrade head
        echo "Migrations completed successfully"
        
    - name: Verify migrations
      env:
        DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        echo "Checking current migration state..."
        alembic current
        echo "Verifying migration history..."
        alembic history
        
    - name: Test migrations down (rollback one step)
      env:
        DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        echo "Testing rollback of last migration..."
        alembic downgrade -1
        echo "Rollback completed successfully"
        
    - name: Re-apply last migration
      env:
        DATABASE_URL: postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
        SECRET_KEY: test-secret-key-for-ci
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        echo "Re-applying last migration..."
        alembic upgrade head
        echo "Migration re-applied successfully"

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, api-tests, migration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: amani-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
