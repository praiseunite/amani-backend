name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, or commit SHA)'
        required: false
        default: 'develop'

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.inputs.ref || github.ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run linting
      run: |
        black --check --diff app/ tests/
        flake8 app/ tests/
    
    - name: Run tests
      env:
        SECRET_KEY: test-secret-key-for-ci
        DATABASE_URL: postgresql+asyncpg://test:test@localhost/test
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        SUPABASE_SERVICE_KEY: test-service-key
        ENVIRONMENT: testing
      run: |
        pytest tests/unit/ -v -m "unit or not integration" --cov=app --cov-report=xml

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.inputs.ref || github.ref }}
        fetch-depth: 0
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate version and build metadata
      id: version
      run: |
        # Get short commit SHA
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        # Get branch name
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
        
        # Generate timestamp
        BUILD_TIME=$(date -u +'%Y%m%d-%H%M%S')
        
        # Create version string
        VERSION="staging-${SHORT_SHA}-${BUILD_TIME}"
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
        
        echo "Version: ${VERSION}"
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=staging-latest
          type=raw,value=staging-${{ steps.version.outputs.short_sha }}
          type=raw,value=${{ steps.version.outputs.version }}
          type=ref,event=branch,prefix=staging-
          type=sha,prefix=staging-
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_VERSION=${{ steps.version.outputs.version }}
          BUILD_SHA=${{ steps.version.outputs.short_sha }}
          BUILD_TIME=${{ steps.version.outputs.build_time }}
          BUILD_BRANCH=${{ steps.version.outputs.branch }}

  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: staging
      url: https://staging-api.amani.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Deploy to staging (placeholder)
      run: |
        echo "Deploying version: ${{ needs.build-and-push.outputs.version }}"
        echo "Image digest: ${{ needs.build-and-push.outputs.image-digest }}"
        echo "Image tags: ${{ needs.build-and-push.outputs.image-tag }}"
        
        # Add actual deployment commands here based on your infrastructure:
        # - kubectl apply for Kubernetes
        # - flyctl deploy for Fly.io
        # - aws ecs update-service for ECS
        # - heroku container:release for Heroku
        
        echo "Deployment would happen here"
    
    - name: Wait for deployment to be ready
      run: |
        echo "Waiting for deployment to be ready..."
        # Add health check polling here
        # Example: wait for https://staging-api.amani.com/api/v1/health to return 200
        sleep 10
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests against staging environment..."
        # Add smoke tests here
        # Example: curl -f https://staging-api.amani.com/api/v1/health || exit 1
        echo "Smoke tests would run here"
    
    - name: Notify deployment success
      if: success()
      run: |
        echo "✅ Staging deployment successful!"
        echo "Version: ${{ needs.build-and-push.outputs.version }}"
        # Add notification to Slack/Teams/Email here
    
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "❌ Staging deployment failed!"
        # Add notification to Slack/Teams/Email here
